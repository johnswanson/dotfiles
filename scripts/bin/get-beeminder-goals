#!/bin/bash
set -euo pipefail

function displaytime {
  local T=$1
  local D=$((T/60/60/24))
  local H=$((T/60/60%24))
  local M=$((T/60%60))
  local S=$((T%60))
  (( $D > 0 )) && printf '%d days ' $D
  (( $H > 0 )) && printf '%d hours ' $H
  (( $M > 0 )) && printf '%d minutes' $M
  (( $D > 0 || $H > 0 || $M > 0 ))
}

while true; do
    for v in $(get-goals | head -n 3); do
        IFS=',' read -ra ADDR <<< "$v"
        due=${ADDR[0]}
        really_due=`expr $due + 1`
        slugs=${ADDR[@]:1}
        NOW=`date +'%s'`
        TIME_UNTIL_DUE=`expr $due - $NOW`
        HR_TIME_UNTIL_DUE=`displaytime $TIME_UNTIL_DUE`
        DUE=`date -d"@$really_due" +"%H:%M"`
        if [ $TIME_UNTIL_DUE -lt 43200 ]; then
            COLOR="#dc322f"
            DUE_TODAY=" <fc=$COLOR>(!)</fc>"
        elif [ $TIME_UNTIL_DUE -lt 129600 ]; then
            COLOR="#859900"
            DUE_TODAY=""
        else
            COLOR="#ffffff"
            DUE_TODAY=""
        fi
        echo "<fc=$COLOR>$slugs</fc> $DUE ($HR_TIME_UNTIL_DUE)$DUE_TODAY"
        sleep 2
    done
done
